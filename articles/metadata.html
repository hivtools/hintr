<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metadata driven UI • hintr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Metadata driven UI">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">hintr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.2.12</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/metadata.html">Metadata driven UI</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Metadata driven UI</h1>
            
      

      <div class="hidden name"><code>metadata.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="motivation">Motivation<a class="anchor" aria-label="anchor" href="#motivation"></a>
</h2>
<p>We wanted to create a unified way to add filters and controls for all
our plots in the front end. Previously there were different approaches
to this for each plot but we wanted to create a unified way to reduce
code duplication, make the interface consistent and mean enhancements to
one plot can easily be ported over to all others. The drop downs in the
side bar are split into two sections, plot controls and filters.</p>
<ol style="list-style-type: decimal">
<li>
<code>controls</code> - dropdowns that influence other
dropdowns</li>
<li>
<code>filters</code> - dropdowns that act as filters for slicing the
data</li>
</ol>
<p>The <code>controls</code> can run <code>effects</code> to modify the
filters such as:</p>
<ul>
<li>Set specific filters as multi-selects. For example, in the barchart
users can select an <code>X Axis</code> and <code>Disaggregate by</code>
controls which set whatever is selected into a multi-select dropdown,
while keeping the rest as single selects. See barchart screenshot</li>
<li>Set selected value for a filter e.g. if users select an indicator we
might want to select specific sex and age groups which have data for
this indicator e.g. ANC indicators should be female and 15-49.</li>
<li>Set filters e.g. ART data has a column for period, ANC data has a
column for year, we want to show the period for filter for ART only and
the year filter for ANC only</li>
<li>Filters can be hidden if we want to simplify the UI to remove
clutter for users whilst ensuring we still filter the underlying
data</li>
<li>Set custom effects that the plot impl can pick up on and use to
control the plot UI e.g. in the table we have a custom effect which
defines for each control what is displayed as a header and as a row in
the table view.</li>
</ul>
<p>Below are some examples of the plot control and filter UIs that the
metadata allow us to build</p>
<div class="section level3">
<h3 id="choropleth">Choropleth<a class="anchor" aria-label="anchor" href="#choropleth"></a>
</h3>
<ul>
<li>Area as a multiselect</li>
</ul>
<p><img src="images%2Fchoropleth-1.png" style="width:100.0%"></p>
</div>
<div class="section level3">
<h3 id="barchart">Barchart<a class="anchor" aria-label="anchor" href="#barchart"></a>
</h3>
<ul>
<li>Indicator control sets filter values</li>
<li>
<code>X Axis</code> &amp; <code>Disaggregate by</code> set the
selected filters as multiselects</li>
</ul>
<p><img src="images%2Fbarchart-1.png" style="width:100.0%"><img src="images%2Fbarchart-2.png" style="width:100.0%"></p>
</div>
<div class="section level3">
<h3 id="table">Table<a class="anchor" aria-label="anchor" href="#table"></a>
</h3>
<ul>
<li>Presets set specific filters as multiselects and what filter to use
as the header group and row</li>
<li>Indicator sets specific filter values to relevant ones for that
indicator</li>
</ul>
<p><img src="images%2Ftable-1.png" style="width:100.0%"><img src="images%2Ftable-2.png" style="width:100.0%"></p>
</div>
</div>
<div class="section level2">
<h2 id="implementation-overview">Implementation overview<a class="anchor" aria-label="anchor" href="#implementation-overview"></a>
</h2>
<p>The backend (this repository) provides metadata JSON endpoints that
tell the frontend how to construct the UI and also how to dynamically
update it based on the value of the dropdowns.</p>
<p>For details on where metadata is currently served from see <a href="#endpoints">Endpoints</a> section.</p>
<p>Reminder that there are two types of dropdowns that can be created
via metadata:</p>
<ol style="list-style-type: decimal">
<li>Dropdowns that influence other dropdowns - we will call these
<code>controls</code> and call their values <code>settings</code>
</li>
<li>Dropdowns that acts as filters for slicing the data - we will call
these <code>filters</code> and their values <code>selections</code>
</li>
</ol>
<p>Here is a useful visualisation of the schema that I’ll keep referring
to so that we don’t get lost in the JSON nesting (note that
<code>indicators</code> is not expanded as this just contains metadata
about the indicator values such as their format which isn’t relevant to
the metadata structure):</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode php"><code class="sourceCode php"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>├── filterTypes[]</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>│   ├── id</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>│   ├── column_id</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>│   ├── use_shape_regions</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>│   ├── options[]</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>│   │   ├── label</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>│   │   ├── id</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>│   │   ├── description</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>├── indicators</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>├── plotSettingsControl{}</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>│   ├── defaultEffect</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>│   │   ├── setFilters</span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>│   │   ├── ... (see effect below)</span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>│   ├── plotSettings[]</span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a>│   │   ├── label</span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>│   │   ├── id</span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a>│   │   ├── hidden</span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>│   │   ├── value</span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a>│   │   ├── options[]</span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a>│   │   │   │   ├── id</span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a>│   │   │   │   ├── label</span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a>│   │   │   │   ├── effect</span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a>│   │   │   │   │   ├── setFilters</span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a>│   │   │   │   │   ├── setMultiple</span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a>│   │   │   │   │   ├── setFilterValues</span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a>│   │   │   │   │   ├── setHidden</span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a>│   │   │   │   │   ├── customPlotEffect</span></code></pre></div>
<p>This is just a full version of the json schema.</p>
</div>
<div class="section level2">
<h2 id="filters">Filters<a class="anchor" aria-label="anchor" href="#filters"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode php"><code class="sourceCode php"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>├── filterTypes[] <span class="co"># here</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>│   ├── id <span class="co"># 1</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>│   ├── column_id <span class="co"># 2</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>│   ├── use_shape_regions <span class="co"># 3</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>│   ├── options[] <span class="co"># 4</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>│   │   ├── label</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>│   │   ├── id</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>│   │   ├── description</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>├── indicators</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>├── plotSettingsControl{}</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>│   ├── defaultEffect</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>│   │   ├── setFilters</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>│   │   ├── ... (see effect below)</span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>│   ├── plotSettings[]</span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>│   │   ├── label</span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>│   │   ├── id</span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>│   │   ├── hidden</span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>│   │   ├── value</span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>│   │   ├── options[]</span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>│   │   │   │   ├── id</span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a>│   │   │   │   ├── label</span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a>│   │   │   │   ├── effect</span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a>│   │   │   │   │   ├── setFilters</span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a>│   │   │   │   │   ├── setMultiple</span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a>│   │   │   │   │   ├── setFilterValues</span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a>│   │   │   │   │   ├── setHidden</span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a>│   │   │   │   │   ├── customPlotEffect</span></code></pre></div>
<p>The <code>filterTypes</code> key is the simplest. It is an array of
all the filters that can be displayed in the UI with their options.
Explanations for each number in the visualisation:</p>
<ol style="list-style-type: decimal">
<li>The <code>id</code> is just an id we can assign to the filter to
refer to it later</li>
<li>The <code>column_id</code> this is the column id of the data which
we have to filter</li>
<li>
<code>use_shape_regions</code> is a boolean that should largely be
ignored, it is a one off trick for geographical area filters only to
reduce the amount of payload we send to the frontend by telling it to
derive the options of a filter select with this boolean from the shape
file that the user has uploaded</li>
<li>The <code>options</code> are the options visible to the user in the
dropdown. Each option has an <code>id</code> by which filter selections
can refer to the option, a <code>label</code> to display in the dropdown
menu and an optional <code>description</code> prop for contextual
information (this doesn’t get displayed to the user at all)</li>
</ol>
</div>
<div class="section level2">
<h2 id="plot-settings-control">Plot Settings Control<a class="anchor" aria-label="anchor" href="#plot-settings-control"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode php"><code class="sourceCode php"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>├── filterTypes[]</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>│   ├── id</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>│   ├── column_id</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>│   ├── use_shape_regions</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>│   ├── options[]</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>│   │   ├── label</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>│   │   ├── id</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>│   │   ├── description</span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>├── indicators</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>├── plotSettingsControl{} <span class="co"># here</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>│   ├── defaultEffect <span class="co"># 1</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>│   │   ├── setFilters</span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>│   │   ├── ... (see effect below)</span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>│   ├── plotSettings[] <span class="co"># 2</span></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>│   │   ├── label <span class="co"># 3</span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a>│   │   ├── id <span class="co"># 4</span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a>│   │   ├── hidden <span class="co"># 5</span></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a>│   │   ├── value <span class="co"># 6</span></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a>│   │   ├── options[]</span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a>│   │   │   │   ├── id <span class="co"># a</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a>│   │   │   │   ├── label</span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a>│   │   │   │   ├── effect</span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a>│   │   │   │   │   ├── setFilters</span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a>│   │   │   │   │   ├── setMultiple</span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a>│   │   │   │   │   ├── setFilterValues</span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a>│   │   │   │   │   ├── setHidden</span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a>│   │   │   │   │   ├── customPlotEffect</span></code></pre></div>
<p>The plot settings controls is an object with keys of the relevant
plot name (e.g. <code>choropleth</code>) and value with the structure
shown in the visualisation. Explanation of keys:</p>
<ol style="list-style-type: decimal">
<li>
<code>defaultEffect</code> is the base effect applied to all
<code>settings</code> (remember these are the values of the
<code>control</code> dropdown) - more on this later</li>
<li>
<code>plotSettings</code> is an array of all the
<code>controls</code> a tab will have</li>
<li>
<code>label</code> is the title of the dropdown the user will see in
the UI</li>
<li>
<code>id</code> is the id of the plot settings (this id is how the
store keeps track of which <code>setting</code> of the
<code>control</code> is selected)</li>
<li>
<code>hidden</code> boolean - there are times we want the
<code>control</code> to be invisible. The calibrate plot reuses the
barchart component, however they expect an <code>X Axis</code> and
<code>Disaggregate by</code> control - these controls are fixed in the
calibrate plot so we set them to a constant value and hide them from the
user allowing us to reuse the barchart component without any special
code</li>
<li>
<code>value</code> is an optional key to set the default value of
the <code>control</code> as something other than the default (default in
frontend for single select is the first value and for a multi-select is
all the values). This is the <code>id</code> of the option
(<code>a</code> in the visualisation)</li>
</ol>
</div>
<div class="section level2">
<h2 id="settings">Settings<a class="anchor" aria-label="anchor" href="#settings"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode php"><code class="sourceCode php"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>├── filterTypes[]</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>│   ├── id</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>│   ├── column_id</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>│   ├── use_shape_regions</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>│   ├── options[]</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>│   │   ├── label</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>│   │   ├── id</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>│   │   ├── description</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>├── indicators</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>├── plotSettingsControl{}</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>│   ├── defaultEffect</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>│   │   ├── setFilters</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>│   │   ├── ... (see effect below)</span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>│   ├── plotSettings[]</span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>│   │   ├── label</span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>│   │   ├── id</span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>│   │   ├── hidden</span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>│   │   ├── value</span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>│   │   ├── options[] <span class="co"># here</span></span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a>│   │   │   │   ├── id <span class="co"># 1</span></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a>│   │   │   │   ├── label <span class="co"># 2</span></span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a>│   │   │   │   ├── effect <span class="co"># 3</span></span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a>│   │   │   │   │   ├── setFilters</span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a>│   │   │   │   │   ├── setMultiple</span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a>│   │   │   │   │   ├── setFilterValues</span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a>│   │   │   │   │   ├── setHidden</span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a>│   │   │   │   │   ├── customPlotEffect</span></code></pre></div>
<p>The <code>settings</code> completely determine the
<code>filters</code> and their <code>selections</code>. The next section
will go through each effect and how the frontend resolves it but for
now, explanation of keys:</p>
<ol style="list-style-type: decimal">
<li>
<code>id</code> for the store to record what <code>setting</code> is
chosen</li>
<li>
<code>label</code> displayed to the user in the dropdown menu</li>
<li>The <code>effect</code> key is probably the most important idea
here. Every <code>setting</code> has an effect associated with it and
aggregating all the effects along all the settings the user has chosen
completely determines the <code>filters</code> and their initial
<code>selections</code> that are shown to the user. So everything can be
derived from just the <code>settings</code> that are chosen</li>
</ol>
</div>
<div class="section level2">
<h2 id="effects">Effects<a class="anchor" aria-label="anchor" href="#effects"></a>
</h2>
<p>Effects are the actions that can be undertaken when a plot control is
selected. They can be used to modify the filters and set custom effects
which can be used by the plot.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode php"><code class="sourceCode php"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>├── filterTypes[]</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>│   ├── id <span class="co"># a</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>│   ├── column_id</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>│   ├── use_shape_regions</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>│   ├── options[]</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>│   │   ├── label</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>│   │   ├── id <span class="co"># b</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>│   │   ├── description</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>├── indicators</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>├── plotSettingsControl{}</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>│   ├── defaultEffect <span class="co"># (here as well)</span></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>│   │   ├── setFilters</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>│   │   ├── ... (see effect below)</span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>│   ├── plotSettings[]</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>│   │   ├── label</span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>│   │   ├── id</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>│   │   ├── hidden</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>│   │   ├── value</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>│   │   ├── options[]</span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>│   │   │   │   ├── id</span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>│   │   │   │   ├── label</span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>│   │   │   │   ├── effect <span class="co"># here</span></span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>│   │   │   │   │   ├── setFilters</span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>│   │   │   │   │   ├── setMultiple</span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>│   │   │   │   │   ├── setFilterValues</span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a>│   │   │   │   │   ├── setHidden</span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a>│   │   │   │   │   ├── customPlotEffect</span></code></pre></div>
<p>For this section we will need a more detailed view of the effects
structure:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode php"><code class="sourceCode php"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>├── setFilters[] <span class="co"># 1</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>│   ├── filterId <span class="co"># 1.1</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>│   ├── label <span class="co"># 1.2</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>│   ├── stateFilterId <span class="co"># 1.3</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>├── setMultiple[] <span class="co"># 2</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>├── setFilterValues{} <span class="co"># 3</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>├── setHidden[] <span class="co"># 4</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>├── customPlotEffect{} <span class="co"># 5</span></span></code></pre></div>
<p>Explanation of each effect and how the frontend aggregates this:</p>
<ol style="list-style-type: decimal">
<li>
<code>setFilters</code> is how the effect specifies what
<code>filters</code> the user sees from the <code>filterTypes</code>.
Only one <code>setFilters</code> effect is used, they are not combined.
So if two <code>settings</code> set filters, the last
<code>setFilters</code> in the for loop would be used when going through
all the <code>settings</code>. Keys:
<ol style="list-style-type: decimal">
<li>
<code>filterId</code> is the <code>id</code> key in a
<code>filterTypes</code>element (<code>a</code> in the schema
above)</li>
<li>
<code>label</code> is the title of the <code>filter</code> displayed
to the user in the UI</li>
<li>
<code>stateFilterId</code> is the id the state uses to identify this
filter. This is distinct to the <code>filterId</code> because in the
bubble plot we have two indicators filters that are the same filter type
(so have the same <code>options</code> and the same
<code>column_id</code>) however they are distinct because one controls
the color of the bubbles and one controls the size of the bubbles so
while both their <code>filterId</code>s are <code>indicator</code>, the
<code>stateFilterId</code>s for both are different,
<code>colorIndicator</code> and <code>sizeIndicator</code>. For most
cases this can be set as the same thing as the <code>filterId</code>.
All other effects will now identify filters by
<code>stateFilterId</code> as these uniquely correspond to what the user
sees</li>
</ol>
</li>
<li>
<code>setMultiple</code> is an effect that converts a
<code>filter</code> to a multi-select dropdown (they are all single
select by default). It is an array of <code>stateFilterId</code>s
(<code>1.3</code> in the schema) This is aggregated via concatenation in
the frontend so if two settings have <code>setMultiple</code> properties
<code>["state_id_1", "state_id_2"]</code> and
<code>["state_id_3"]</code> respectively then all three filters with
those state ids will be set to multi-selects</li>
<li>
<code>setFilterValues</code> is an effect that sets the selection of
the filters in <code>setFilters</code>. It is an object with keys equal
to <code>stateFilterId</code> and value an array of ids of the
<code>selections</code> (<code>b</code> in the schema). Note this is
still an array of length one if you want to specify a value for a single
select filter. This is aggregated by the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Spread_syntax#spread_in_object_literals" class="external-link">spread
operator</a> in the frontend</li>
<li>
<code>setHidden</code> is an effect that hides <code>filters</code>
and is usually used when we have a fixed filter that we don’t want the
user to change but is still required to slice the data. This is
aggregated via concatenation in the frontend</li>
<li>
<code>customPlotEffect</code> is an effect that plots can use to
build reactive UI from for a specific plot type. At the moment we are
only using this in the table, so set the row and header groups. But it
could be expanded to general metadata which we want a plot control to
update, but does not have an effect on the filters themselves.</li>
</ol>
<div class="section level3">
<h3 id="statefilterid-vs-filterid">stateFilterId vs filterId<a class="anchor" aria-label="anchor" href="#statefilterid-vs-filterid"></a>
</h3>
<p>To hammer it home for Rob because he can’t remember this no matter
how many times he reads it. <code>FilterRef</code>s have a
<code>filterId</code> and <code>stateFilterId</code></p>
<ul>
<li>
<code>filterId</code> - used to identify the <code>id</code> in the
full set of <code>filters</code> i.e. to get the label and options for
this filter</li>
<li>
<code>stateFilterId</code> - reference to this filter within the
rest of the metadata and the effects i.e. to identify which drop down to
update when a plot control changes</li>
</ul>
<p>This is because on the bubble plot, there are two drop downs which
have <code>indicator</code> as their options, but run different
effects.</p>
</div>
</div>
<div class="section level2">
<h2 id="typescript-definition-and-derived-frontend-store">Typescript definition and derived frontend store<a class="anchor" aria-label="anchor" href="#typescript-definition-and-derived-frontend-store"></a>
</h2>
<p>I have used the directory-structure-esque visualisation for most of
this because it is simple and obscures a lot of the types and other
information as that would be too much to throw. But now that you know
how the metadata works, here is the full typescript definition of it
with contextual types (instead of just <code>string</code>, it shows
which type of string it refers to, e.g. whether it is
<code>stateFilterId</code> or <code>filterId</code>):</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="kw">type</span> FilterId <span class="op">=</span> <span class="dt">string</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="kw">type</span> StateFilterId <span class="op">=</span> <span class="dt">string</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="kw">type</span> ColumnId <span class="op">=</span> <span class="dt">string</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="kw">type</span> SelectionId <span class="op">=</span> <span class="dt">string</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="kw">type</span> PlotControlId <span class="op">=</span> <span class="dt">string</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="kw">type</span> PlotSettingId <span class="op">=</span> <span class="dt">string</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a><span class="kw">type</span> PlotName <span class="op">=</span> <span class="dt">string</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="kw">type</span> FilterOption <span class="op">=</span> {</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>    id<span class="op">:</span> SelectionId<span class="op">,</span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>    label<span class="op">:</span> <span class="dt">string</span><span class="op">,</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>    description<span class="op">:</span> <span class="dt">string</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>}</span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a><span class="kw">type</span> FilterType <span class="op">=</span> {</span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>    id<span class="op">:</span> FilterId<span class="op">,</span></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a>    column_id<span class="op">:</span> ColumnId<span class="op">,</span></span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a>    options<span class="op">:</span> FilterOption[]</span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a>}</span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a><span class="kw">type</span> FilterRef <span class="op">=</span> {</span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a>    filterId<span class="op">:</span> FilterId<span class="op">,</span></span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a>    label<span class="op">:</span> <span class="dt">string</span><span class="op">,</span></span>
<span id="cb7-24"><a href="#cb7-24" tabindex="-1"></a>    stateFilterId<span class="op">:</span> StateFilterId</span>
<span id="cb7-25"><a href="#cb7-25" tabindex="-1"></a>}</span>
<span id="cb7-26"><a href="#cb7-26" tabindex="-1"></a></span>
<span id="cb7-27"><a href="#cb7-27" tabindex="-1"></a><span class="kw">type</span> PlotSettingEffect <span class="op">=</span> {</span>
<span id="cb7-28"><a href="#cb7-28" tabindex="-1"></a>    setFilters<span class="op">?:</span> FilterRef[]<span class="op">,</span></span>
<span id="cb7-29"><a href="#cb7-29" tabindex="-1"></a>    setMultiple<span class="op">?:</span> StateFilterId[]<span class="op">,</span></span>
<span id="cb7-30"><a href="#cb7-30" tabindex="-1"></a>    setFilterValues<span class="op">?:</span> <span class="bu">Record</span><span class="op">&lt;</span>StateFilterId<span class="op">,</span> SelectionId[]<span class="op">&gt;,</span></span>
<span id="cb7-31"><a href="#cb7-31" tabindex="-1"></a>    setHidden<span class="op">?:</span> StateFilterId[]<span class="op">,</span></span>
<span id="cb7-32"><a href="#cb7-32" tabindex="-1"></a>    customPlotEffect<span class="op">?:</span> <span class="dt">any</span></span>
<span id="cb7-33"><a href="#cb7-33" tabindex="-1"></a>}</span>
<span id="cb7-34"><a href="#cb7-34" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" tabindex="-1"></a><span class="kw">type</span> PlotSettingOption <span class="op">=</span> {</span>
<span id="cb7-36"><a href="#cb7-36" tabindex="-1"></a>    id<span class="op">:</span> PlotSettingId<span class="op">,</span></span>
<span id="cb7-37"><a href="#cb7-37" tabindex="-1"></a>    label<span class="op">:</span> <span class="dt">string</span><span class="op">,</span></span>
<span id="cb7-38"><a href="#cb7-38" tabindex="-1"></a>    effect<span class="op">:</span> PlotSettingEffect</span>
<span id="cb7-39"><a href="#cb7-39" tabindex="-1"></a>}</span>
<span id="cb7-40"><a href="#cb7-40" tabindex="-1"></a></span>
<span id="cb7-41"><a href="#cb7-41" tabindex="-1"></a><span class="kw">type</span> PlotSetting <span class="op">=</span> {</span>
<span id="cb7-42"><a href="#cb7-42" tabindex="-1"></a>    id<span class="op">:</span> PlotControlId<span class="op">,</span></span>
<span id="cb7-43"><a href="#cb7-43" tabindex="-1"></a>    label<span class="op">:</span> <span class="dt">string</span><span class="op">,</span></span>
<span id="cb7-44"><a href="#cb7-44" tabindex="-1"></a>    hidden<span class="op">?:</span> <span class="dt">boolean</span><span class="op">,</span></span>
<span id="cb7-45"><a href="#cb7-45" tabindex="-1"></a>    value<span class="op">?:</span> PlotSettingId<span class="op">,</span></span>
<span id="cb7-46"><a href="#cb7-46" tabindex="-1"></a>    options<span class="op">:</span> PlotSettingOption[]</span>
<span id="cb7-47"><a href="#cb7-47" tabindex="-1"></a>}</span>
<span id="cb7-48"><a href="#cb7-48" tabindex="-1"></a></span>
<span id="cb7-49"><a href="#cb7-49" tabindex="-1"></a><span class="kw">type</span> PlotSettingsControl <span class="op">=</span> {</span>
<span id="cb7-50"><a href="#cb7-50" tabindex="-1"></a>    defaultEffect<span class="op">:</span> PlotSettingEffect<span class="op">,</span></span>
<span id="cb7-51"><a href="#cb7-51" tabindex="-1"></a>    plotSettings<span class="op">:</span> PlotSetting[]</span>
<span id="cb7-52"><a href="#cb7-52" tabindex="-1"></a>}</span>
<span id="cb7-53"><a href="#cb7-53" tabindex="-1"></a></span>
<span id="cb7-54"><a href="#cb7-54" tabindex="-1"></a><span class="kw">type</span> MetadataStructure <span class="op">=</span> {</span>
<span id="cb7-55"><a href="#cb7-55" tabindex="-1"></a>    filterTypes<span class="op">:</span> FilterType[]<span class="op">,</span></span>
<span id="cb7-56"><a href="#cb7-56" tabindex="-1"></a>    indicators<span class="op">:</span> <span class="dt">any</span><span class="op">,</span> <span class="co">// irrelevant </span></span>
<span id="cb7-57"><a href="#cb7-57" tabindex="-1"></a>    plotSettingsControl<span class="op">:</span> {</span>
<span id="cb7-58"><a href="#cb7-58" tabindex="-1"></a>        <span class="co">// example of plotName can be choropleth or table, etc</span></span>
<span id="cb7-59"><a href="#cb7-59" tabindex="-1"></a>        [plotName<span class="op">:</span> PlotName]<span class="op">:</span> PlotSettingsControl</span>
<span id="cb7-60"><a href="#cb7-60" tabindex="-1"></a>    }</span>
<span id="cb7-61"><a href="#cb7-61" tabindex="-1"></a>}</span></code></pre></div>
<div class="section level3">
<h3 id="selections-state">Selections state<a class="anchor" aria-label="anchor" href="#selections-state"></a>
</h3>
<p>Remember the frontend store is also fully derived from this metadata.
Nothing is hardcoded in the store expect for the <code>plotNames</code>
so the derived store takes the type:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="kw">type</span> FilterSelection <span class="op">=</span> {</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>    multiple<span class="op">:</span> <span class="dt">boolean</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>    selection<span class="op">:</span> FilterOption[]<span class="op">,</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>    hidden<span class="op">:</span> <span class="dt">boolean</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>} <span class="op">&amp;</span> FilterRef</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a><span class="kw">type</span> ControlSelection <span class="op">=</span> {</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>    id<span class="op">:</span> PlotControlId<span class="op">,</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>    label<span class="op">:</span> <span class="dt">string</span><span class="op">,</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>    selection<span class="op">:</span> FilterOption[]</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>}</span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a><span class="kw">type</span> FrontendSelectionState <span class="op">=</span> {</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>    <span class="co">// these plotNames keys in the type are the generated keys from</span></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>    <span class="co">// the json schema in Hintr</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>    [plotName<span class="op">:</span> PlotName]<span class="op">:</span> {</span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>        controls<span class="op">:</span> ControlSelection[]</span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>        filters<span class="op">:</span> FilterSelection[]</span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a>    }</span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>} <span class="op">&amp;</span> { error<span class="op">:</span> <span class="bu">Error</span> }</span></code></pre></div>
<p>Note that the state stores some extra information other than the
selections of each of the dropdowns, this is to reduce the need to parse
the metadata all the time. However, every time an update to the
<code>controls</code> occurs. the frontend has to parse the metadata,
aggregate all the effects and dynamically render all the filters again.
In practice this is very fast.</p>
</div>
<div class="section level3">
<h3 id="data-state">Data state<a class="anchor" aria-label="anchor" href="#data-state"></a>
</h3>
<p>The data state is quite simple. It takes the form:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="kw">type</span> FrontendDataState <span class="op">=</span> {</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>    <span class="co">// just an array of filtered data</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>    [plotName<span class="op">:</span> PlotName]<span class="op">:</span> <span class="dt">any</span>[]</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="endpoints">Endpoints<a class="anchor" aria-label="anchor" href="#endpoints"></a>
</h2>
<p>For each data source in the frontend UI there is a different endpoint
and associated JSON schema that specifies the metadata. Note this will
probably go stale but should give a starting point</p>
<table class="table">
<colgroup>
<col width="12%">
<col width="12%">
<col width="26%">
<col width="34%">
<col width="16%">
</colgroup>
<thead><tr class="header">
<th>Step</th>
<th>Plot</th>
<th>Data source</th>
<th>Metadata source</th>
<th>Schema</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Input review</td>
<td>Time series</td>
<td><code>/chart-data/input-time-series/&lt;anc/art&gt;</code></td>
<td><code>/review-input/metadata</code></td>
<td><a href="../inst/schema/ReviewInputFilterMetadataResponse.schema.json">Review
inputs</a></td>
</tr>
<tr class="even">
<td>Input review</td>
<td>Choropleth</td>
<td><code>/validate/survey-and-programme</code></td>
<td><code>/review-input/metadata</code></td>
<td><a href="../inst/schema/ReviewInputFilterMetadataResponse.schema.json">Review
inputs</a></td>
</tr>
<tr class="odd">
<td>Input review</td>
<td>Comparison table</td>
<td><code>/chart-data/input-comparison</code></td>
<td><code>/chart-data/input-comparison</code></td>
<td><a href="../inst/schema/InputComparisonResponse.schema.json">Input
comparison</a></td>
</tr>
<tr class="even">
<td>Input review</td>
<td>Comparison barchart</td>
<td><code>/chart-data/input-comparison</code></td>
<td><code>/chart-data/input-comparison</code></td>
<td><a href="../inst/schema/InputComparisonResponse.schema.json">Input
comparison</a></td>
</tr>
<tr class="odd">
<td>Input review</td>
<td>Population</td>
<td>
<code>/validate/baseline-individual</code> only for population
data</td>
<td><code>/chart-data/input-population</code></td>
<td><a href="../inst/schema/InputPopulationMetadataResponse.schema.json">Input
population</a></td>
</tr>
<tr class="even">
<td>Calibrate</td>
<td>Calibration barchart</td>
<td><code>/calibrate/plot/&lt;id&gt;</code></td>
<td><code>/calibrate/plot/&lt;id&gt;</code></td>
<td><a href="../inst/schema/CalibratePlotResponse.schema">Calibrate
plot</a></td>
</tr>
<tr class="odd">
<td>Output review</td>
<td>Choropleth</td>
<td>
<code>/calibrate/result/path/&lt;id&gt;</code> (*)</td>
<td><code>/calibrate/result/metadata/&lt;id&gt;</code></td>
<td><a href="../inst/schema/CalibrateMetadataResponse.schema.json">Review
output</a></td>
</tr>
<tr class="even">
<td>Output review</td>
<td>Barchart</td>
<td>
<code>/calibrate/result/path/&lt;id&gt;</code> (*)</td>
<td><code>/calibrate/result/metadata/&lt;id&gt;</code></td>
<td><a href="../inst/schema/CalibrateMetadataResponse.schema.json">Review
output</a></td>
</tr>
<tr class="odd">
<td>Output review</td>
<td>Choropleth</td>
<td>
<code>/calibrate/result/path/&lt;id&gt;</code> (*)</td>
<td><code>/calibrate/result/metadata/&lt;id&gt;</code></td>
<td><a href="../inst/schema/CalibrateMetadataResponse.schema.json">Review
output</a></td>
</tr>
<tr class="even">
<td>Output review</td>
<td>Table</td>
<td>
<code>/calibrate/result/path/&lt;id&gt;</code> (*)</td>
<td><code>/calibrate/result/metadata/&lt;id&gt;</code></td>
<td><a href="../inst/schema/CalibrateMetadataResponse.schema.json">Review
output</a></td>
</tr>
<tr class="odd">
<td>Output review</td>
<td>Comparison</td>
<td><code>/comparison/plot/&lt;id&gt;</code></td>
<td><code>/comparison/plot/&lt;id&gt;</code></td>
<td><a href="../inst/schema/CalibrateMetadataResponse.schema.json">Output
comparison</a></td>
</tr>
<tr class="even">
<td>Output review</td>
<td>Bubble</td>
<td>
<code>/calibrate/result/path/&lt;id&gt;</code> (*)</td>
<td><code>/calibrate/result/metadata/&lt;id&gt;</code></td>
<td><a href="../inst/schema/ComparisonPlotResponse.schema">Review
output</a></td>
</tr>
<tr class="odd">
<td>Output review</td>
<td>Cascade</td>
<td>
<code>/calibrate/result/path/&lt;id&gt;</code> (*)</td>
<td><code>/calibrate/result/metadata/&lt;id&gt;</code></td>
<td><a href="../inst/schema/ComparisonPlotResponse.schema">Review
output</a></td>
</tr>
</tbody>
</table>
<p>(*) Kotlin backend gets the path to the duckdb output file using
hintr endpoint at <code>/calibrate/result/path/&lt;id&gt;</code>. It
then slices this using SQL based on the filters the user set in the
front end. So we only return the slice of data the user is looking
at.</p>
<p>Note that data and metadata can be in the same endpoint or different
ones. Favour returning them from the same endpoint unless splitting them
up will significantly speed up the UI e.g. returning metadata for output
plots all together saves reading the output and building the filters
from this multiple times. In general, I think having the data &amp;
metadata returned together is simpler.</p>
</div>
<div class="section level2">
<h2 id="front-end-implementation">Front end implementation<a class="anchor" aria-label="anchor" href="#front-end-implementation"></a>
</h2>
<p>This section gives an overview of how the front end handles the
metadata and where any custom logic for a specific plot should be
injected. The aim of the front end impl is that the wiring up of state
will be as straight forward as possible, and we get as much code use as
possible.</p>
<div class="section level3">
<h3 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h3>
<div class="section level4">
<h4 id="data-fetching">Data fetching<a class="anchor" aria-label="anchor" href="#data-fetching"></a>
</h4>
<p><strong>For output plots</strong> data is fetched on demand when
users set filters, therefore there is no big blob of data in state
<strong>For all other plots</strong> data is pre-fetched via a store
action. This might be when an input file is uploaded (e.g. population,
survey, ART, ANC), or when a plot is opened e.g. input comparison, input
time series. Data is fetched via an action and saved in the store state
somewhere, this varies from data source to data source but will be in
<code>baseline</code>, <code>surveyAndProgramme</code>,
<code>reviewInput</code></p>
</div>
<div class="section level4">
<h4 id="metadata-fetching">Metadata fetching<a class="anchor" aria-label="anchor" href="#metadata-fetching"></a>
</h4>
<p>Metadata is fetched via a store action which calls to endpoints in
the table above. It can be fetched as part of the same endpoint as the
data, or separately. When metadata is fetched separately we typically do
a couple of modifications before saving it into the store. Firstly, if
the data has <code>use_shape_regions</code> or
<code>use_shape_area_level</code> set we fill in these filter options
from those already in state. We also commit the initial selections, this
runs any default effects and saves them resulting controls and filters
into <code>plotSelections</code> state, it also runs
<code>getPlotData</code> which manges running the plot-specific
filtering logic and saves this into the <code>plotData</code> state.</p>
</div>
<div class="section level4">
<h4 id="on-mount">On mount<a class="anchor" aria-label="anchor" href="#on-mount"></a>
</h4>
<p>The plot should have a prop which is of type <code>PlotName</code>.
It should then read the metadata via the
<code>getMetadataFromPlotName</code> helper and use the data from
<code>plotData</code> state. For each specific plot, it should then
modify the <code>plotData</code> into a structure which can be used by
plot component. Potentially using metadata if it needs, including any
<code>customPlotEffect</code>s for the selection.</p>
</div>
<div class="section level4">
<h4 id="on-plot-controlfilter-update">On plot control/filter update<a class="anchor" aria-label="anchor" href="#on-plot-controlfilter-update"></a>
</h4>
<p>This dispatches an action
<code>plotSelections/updateSelections</code> which runs any effects to
get the new state, it then runs <code>getPlotData</code> updating the
<code>plotData</code> in state with the filtered data.</p>
</div>
</div>
<div class="section level3">
<h3 id="adding-new-plot">Adding new plot<a class="anchor" aria-label="anchor" href="#adding-new-plot"></a>
</h3>
<p>If you are using an existing data source or metadata source, you will
need to</p>
<ol style="list-style-type: decimal">
<li>Add metadata into existing endpoint or new endpoint</li>
<li>If a new endpoint, add an action which fetched the metadata, runs
<code>filtersAfterUseShapeRegions</code> and
<code>commitPlotDefaultSelections</code>.</li>
<li>Add the new plot type into <code>PlotName</code>
</li>
<li>Add handling for new plot type into
<code>getMetadataFromPlotName</code>, it should just map to the location
of the metadata</li>
<li>Add handling for new plot type into <code>getPlotData</code>, if
this is using a new data source, write a function to do the filtering
for this data source, and run any specific logic for this data source
type.</li>
<li>Write the component pulling data from <code>plotData</code> state
and metadata via <code>getMetadataFromPlotName</code>.</li>
</ol>
</div>
<div class="section level3">
<h3 id="where-do-i-write-custom-logic">Where do I write custom logic?<a class="anchor" aria-label="anchor" href="#where-do-i-write-custom-logic"></a>
</h3>
<p><strong>Modify the metadata before it is ever used</strong>, write it
in the action after the data is fetched and before it saved to state.
For example, setting options for a filter to those from the shape
file.</p>
<p><strong>Customise the filter logic</strong>, write it in one of the
function <code>getPlotData</code> calls to. For example can use this to
switch between different data sources in one plot (time series), derive
some data from selections (population data gets aggregated to selected
level)</p>
<p><strong>Modify selections when a plot control changes</strong>, hook
into the filtering logic, you can do this in
<code>handlePlotControlOverrides</code>. We have used this to set x-axis
for the comparison barchart. Plot selections cannot by default update
other plot selections, but we wanted this for the comparison barchart.
We wanted the UI to show a “plot type” control but not let users modify
the x-axis because they could easily break the display. Instead we have
a hidden x-axis and then hook into the filtering logic to set the x-axis
control if the “plot control” is changed. This one I think we should be
careful with, if we spot common overrides we should think about
refactoring this into an effect.</p>
<p><strong>Modify the plot itself based on a plot control</strong>, use
a <code>customPlotEffect</code> to set metadata for this specific plot
selection e.g. for the table we specify in <code>customPlotEffect</code>
what category in the data should be a column group or shown in the
rows.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Robert Ashton.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
